apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: observability
data:
  alertmanager.yml: |
    global:
      slack_api_url_file: /etc/alertmanager/secrets/slack_api_url
      resolve_timeout: 5m

    route:
      receiver: 'slack-alerts'
      group_by: ['alertname', 'job']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 3h

    receivers:
      - name: 'slack-alerts'
        slack_configs:
          - channel: '#alerts'
            send_resolved: true
            icon_url: 'https://example.com/portfogram-logo.png'
            username: 'PortfoGram AlertBot'
            text: '{{ template "slack.text" . }}'
            footer: 'PortfoGram Alertmanager'

    templates:
      - '/etc/alertmanager/templates.tmpl'

  templates.tmpl: |
    {{ define "slack.text" }}
    {{ if eq .Status "firing" }}ðŸš¨ *ALERT FIRING*{{ else }}âœ… *ALERT RESOLVED*{{ end }}

    *Alert:* `{{ .CommonLabels.alertname }}`
    *Severity:* `{{ .CommonLabels.severity | toUpper }}`
    *Summary:* {{ (index .Alerts 0).Annotations.summary }}

    {{ if eq .Status "firing" }}
    *Affected Instances:* {{ .Alerts | len }}
    {{ end }}

    {{ range .Alerts }}
    ---
    {{ if .Annotations.description }}
    *Description:* {{ .Annotations.description }}
    {{ end }}
    *Started:* <!date^{{ .StartsAt.Unix }}^{date_num} {time_secs}|{{ .StartsAt.Format "2006-01-02 15:04:05" }}>
    {{ if ne .Status "firing" }}
    *Ended:* <!date^{{ .EndsAt.Unix }}^{date_num} {time_secs}|{{ .EndsAt.Format "2006-01-02 15:04:05" }}>
    {{ end }}

    *Labels:*
    {{ range .Labels.SortedPairs }}  â€¢ *{{ .Name }}:* `{{ .Value }}`
    {{ end }}
    {{ if .Annotations.runbook_url }}
    *Runbook:* <{{ .Annotations.runbook_url }}|View runbook>
    {{ end }}
    {{ end }}

    *Actions:*
    â€¢ <{{ (index .Alerts 0).GeneratorURL }}|:mag: View in Prometheus>
    {{ if (index .Alerts 0).Annotations.dashboard_url }}
    â€¢ <{{ (index .Alerts 0).Annotations.dashboard_url }}|:bar_chart: View Dashboard>
    {{ end }}
    â€¢ <https://your-alertmanager-url.com/#/silences/new?filter=%7balertname%3D%22{{ .CommonLabels.alertname }}%22%7d|:no_bell: Silence Alert>

    {{ if eq .Status "firing" }}
    <!here> *This alert requires immediate attention. Please investigate and take necessary actions.*
    {{ else }}
    *The alert has been resolved. No further action is required.*
    {{ end }}
    {{ end }}